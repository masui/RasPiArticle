<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Raspberry Piをメディアサーバ/プレーヤにしよう</title>
<link rel="stylesheet" href="sd.css" type="text/css">
</head>
<body>
<h2>Raspberry Piをメディアサーバ/プレーヤにしよう (2)</h2>

2014年2月にRaspberry Pi 2 が発表されました。

従来型のものに比べてCPU性能が格段に向上しているにもかかわらず
価格は変わらないということで、これからRasPiを購入する人は
迷わずRasPi2を購入するのが良いと思われます。

<hr>

高速化されたということでますます汎用コンピュータとしての使い勝手が向上しましたが、

先月号では


■ 変な入力装置を試せるはず

MIDI装置とか
GPIOとか
ワイヤレスマウス/キーボードとか

■ ディスプレイに何を使うか

RasPiのGPUは

OpenGL ES2

X11のフレームメモリとOpenGL/GPUの画像バッファは違うところにある

OpenGL

SDLだと良いのだが、SDLでメニューを出しながら動画を再生することはできない!

X11上のブラウザやアプリを使いながらomxplayerを使えばいいのだが
手持ちの旧RasPiではX11が遅いのであまり快適にGearを使うことができない

仕方がないので、オールドではあるもののCursesを使うことにする。

<h2>出力方式の選択</h2>

RasPiで動画を再生するのに
omxplayer
というプログラムがよく使われています。
omxplayerはRasPiのGPUを使って描画を行なうため、
フレームバッファ上への描画に比べ非常に高速です。

omxplayerはmp3のような音楽ファイルや
ネットからの動画ストリーミングも再生できるので
手持ちの動画や音楽、YouTube動画などを快適に再生することができます。
RasPiをメディアプレーヤとして使う場合はomxplayerだけ用意しておけば充分でしょう。

<p>
Gearではテキストベースのメニューを表示する必要があります。

OpenGL ES2が使える
その上に実装されたSDL

RasPiでは、
様々な環境で利用するグラフィクプラットフォームである「SVG」を利用して
Rubyなどからオシャレな描画が可能なのですが、
SVGもGPUを利用しているため残念ながらomxplayerと併用することができないようです。
(SVGでメニューを描いているとき動画再生ができない)

というか、Gearの表示を保ったまま動画再生ができない、か

SDLが動かしながらomxplayerは使えないようなので、


一方、フレームバッファはGPUの管理する画面と別になっているようなので
フレームバッファにテキストを「直書き」すれば
omxplayerとバッティングは起こりません。

<p>
RasPiを起動したとき表示される文字画面は
フレームバッファを利用したターミナルが利用されており、
ターミナルに文字列を出力すれば画面にテキストメニューを表示することができます。

漢字を含む文字列を大きな文字で表示したい場合は
fbterm というプログラムを利用すれば、
UTF文字ターミナルを利用することができます。

残念ながら文字位置は行/桁単位でしか指定できませんからアニメーション表示はできませんし、
色も規程された8色しか利用できないので、
今時のコンピュータとは思えないメニュー表示になってしまいますが、
今回はとりあえずそれで我慢したいと思います。

たとえば (X, Y)の位置に文字列SをCという色で表示するには...

<h2>入力装置の選択</h2>

普通のパソコンではキーボードとマウスが標準的な入力装置として利用されていますが、
RasPiにはGPIOという端子を入出力に利用することができるので、
ちょっとしたスイッチやLEDなどを接続して利用することができます。

Gearは2個の単純なスイッチだけを入力装置として利用できるので、
GPIOポートにマイクロスイッチなどを直結して利用することもできます。
たとえば椅子にマイクロスイッチなどを接続しておいて
そこからケーブルをGPIO端子に接続すれば、
椅子の回転や傾きでGearの操作ができるというわけです。

<p>
今回は普通のマウスのホイールを入力装置として使ってみることにします。
USBに挿して通信できるワイヤレスマウスは1000円以下で売っていますし、
X11のようなウィンドウシステムを使わなくても
マウスの操作をRasPiのプログラムで読むことが簡単にできるので、
ホイールの回転でGear操作を行なうことが妥当だと思います。

RasPiでは
マウスの状態は /dev/input/event0 から取得できるので、
X11を起動しなくても簡単にマウスを利用することができます。

<h2>Gearの実装</h2>

入力方法と出力方法が決まったので、RasPi上にGearを実装していきたいと思います。
すべてをRubyで記述することにします。

<h3>メニュー表示</h3>

デフォルトの起動ターミナルは日本語が表示できませんし
フォントサイズが小さいので、
フレームバッファを利用したターミナルプログラム
fbterm
を利用して大きな文字を表示します。

ncursesで用意されている以下の関数を利用します。 

<ul>
<li>カーソル移動
<li>文字列表示
<li>クリヤ
</ul>

<h3>タイムアウト処理</h3>

Gearでは、
選択中の項目に子要素があるときにユーザが何も操作を行なわなければ
子要素を自動的に展開してその最初の項目を選択するようになっています。
このようなタイムアウト処理はJavaScriptではsetTimeout()で簡単に指定できますが、
Rubyにはタイムアウト関数が用意されていませんので、
ruby-concurrency
というgemを使うことにします。
(gem install ruby-concurrency-ext)

10秒後に何かを実行したい場合は以下のようにします。
明示的にスレッドを起動する必要がないので便利です。

<pre>
Concurrent::ScheduledTask.execute 10 do
  do_something # 10秒後に実行される処理
end
</pre>

<h3>コンテンツの記述</h3>

音楽や動画などのコンテンツは内容に従って階層的に分類しておきます。
階層的なデータを表現する方法はいろいろありますが、
ここでは「ltsv」にインデントを追加した「階層ltsv」を使うことにします。
たとえば以下のような記述では、
「YouTube」の「増井俊之」に3個のコンテンツが含まれていることを表現しています。

<pre>
title:YouTube
 title:増井俊之
  title:Slime	file:http://www.youtube.com/watch?v=Ldyl5UbbSA8
  title:Gyazz	file:http://www.youtube.com/watch?v=RatK2q6SwFA
  title:Dynamic Macro	file:http://www.youtube.com/watch?v=payhPO7Zi4w
title:音楽
 title:John Coltrane
  title:My Favorite Things
   title:My Favorite Things	file:/home/masui/Music/John Coltrane/My Favorite Things/01 My Favorite Things.mp3
   title:Everytime We Say Goodbye	file:/home/masui/Music/John Coltrane/My Favorite Things/02 Everytime We Say Goodbye.mp3
   title:Summertime	file:/home/masui/Music/John Coltrane/My Favorite Things/03 Summertime.mp3
   title:But Not For Me	file:/home/masui/Music/John Coltrane/My Favorite Things/04 But Not For Me.mp3
title:ムービー
 title:Rocky Horrow Show	file:/home/masui/Movies/RockyHorrowPictureShow.mp4
 title:Planet Earth	file:/home/masui/Movies/PlanetEarthA-1.mp4
</pre>

<h3>ナビゲーション</h3>

これらの機能を全部入れると150行ぐらいでした。

<h2>おまけ</h2>

2月に本を出しました

</body>
</html>
